<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/styles.css}" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-success mb-4 shadow">
    <div class="container-fluid px-4">
        <span class="navbar-brand mb-0 h1"><i class="fas fa-chart-line me-2"></i>Komyut Analytics</span>
        <form th:action="@{/logout}" method="post" class="d-inline">
            <button class="btn btn-sm btn-light text-success fw-bold">Logout <i class="fas fa-sign-out-alt"></i></button>
        </form>
    </div>
</nav>

<div class="container-fluid px-4">
    
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-white h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase mb-2">Overall Satisfaction</h6>
                    <h1 class="display-4 fw-bold text-success mb-0" th:text="${overallRating}">4.5</h1>
                    <div class="text-warning small"><i class="fas fa-star"></i> Global Average</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-white h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase mb-2">Total Reviews</h6>
                    <h1 class="display-4 fw-bold text-dark mb-0" th:text="${totalReviews}">120</h1>
                    <small class="text-muted">All categories combined</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-white h-100">
                <div class="card-body text-center">
                    <h6 class="text-muted text-uppercase mb-2">Hidden Reviews</h6>
                    <h1 class="display-4 fw-bold text-danger mb-0" th:text="${hiddenReviews}">5</h1>
                    <small class="text-danger">Moderated content</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-0 bg-white h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase mb-3 text-center">Category Averages</h6>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="fas fa-user-tie text-primary"></i> Drivers</span>
                        <strong th:text="${driverAvg}">0.0</strong>
                    </div>
                    <div class="d-flex justify-content-between border-bottom pb-2 mb-2">
                        <span><i class="fas fa-route text-success"></i> Routes</span>
                        <strong th:text="${routeAvg}">0.0</strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span><i class="fas fa-bus text-warning"></i> Vehicles</span>
                        <strong th:text="${vehicleAvg}">0.0</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        
        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-user-tie me-2"></i>Driver Performance</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0 small">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th class="text-center">Rating</th>
                                <th class="text-center">Reviews</th>
                                <th>QR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="d : ${drivers}">
                                <td th:text="${d.name}" class="fw-bold"></td>
                                <td class="text-center">
                                    <span class="badge" th:classappend="${d.averageRating >= 4.0 ? 'bg-success' : (d.averageRating >= 2.5 ? 'bg-warning' : 'bg-danger')}" th:text="${d.averageRating}"></span>
                                </td>
                                <td class="text-center" th:text="${d.reviewCount}"></td>
                                <td>
                                    <a th:href="@{/admin/qr(type='driver', id=${d.id})}" target="_blank" class="text-primary"><i class="fas fa-print"></i></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center" style="background-color: #2e7d32 !important;">
                    <span class="fw-bold"><i class="fas fa-route me-2"></i>Route Performance</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0 small">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th class="text-center">Rating</th>
                                <th class="text-center">Reviews</th>
                                <th>QR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="r : ${routes}">
                                <td th:text="${r.name}" class="fw-bold text-truncate" style="max-width: 150px;"></td>
                                <td class="text-center">
                                    <span class="badge" th:classappend="${r.averageRating >= 4.0 ? 'bg-success' : (r.averageRating >= 2.5 ? 'bg-warning' : 'bg-danger')}" th:text="${r.averageRating}"></span>
                                </td>
                                <td class="text-center" th:text="${r.reviewCount}"></td>
                                <td>
                                    <a th:href="@{/admin/qr(type='route', id=${r.id})}" target="_blank" class="text-success"><i class="fas fa-print"></i></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                    <span class="fw-bold"><i class="fas fa-bus me-2"></i>Vehicle Performance</span>
                </div>
                <div class="card-body p-0">
                    <table class="table table-striped table-hover mb-0 small">
                        <thead class="table-light">
                            <tr>
                                <th>Type / Plate</th>
                                <th class="text-center">Rating</th>
                                <th class="text-center">Reviews</th>
                                <th>QR</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="v : ${vehicles}">
                                <td>
                                    <span th:text="${v.type}" class="fw-bold d-block"></span>
                                    <span th:text="${v.plateNumber}" class="text-muted small"></span>
                                </td>
                                <td class="text-center align-middle">
                                    <span class="badge" th:classappend="${v.averageRating >= 4.0 ? 'bg-success' : (v.averageRating >= 2.5 ? 'bg-warning' : 'bg-danger')}" th:text="${v.averageRating}"></span>
                                </td>
                                <td class="text-center align-middle" th:text="${v.reviewCount}"></td>
                                <td class="align-middle">
                                    <a th:href="@{/admin/qr(type='vehicle', id=${v.id})}" target="_blank" class="text-warning"><i class="fas fa-print"></i></a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white fw-bold">
                    <i class="fas fa-chart-bar me-2"></i>Global Rating Distribution
                </div>
                <div class="card-body">
                    <canvas id="ratingDistChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="card shadow-sm border-0 mb-5">
        <div class="card-header bg-dark text-white">
            <span><i class="fas fa-gavel me-2"></i>Review Moderation Queue</span>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>User</th>
                            <th>Entity</th>
                            <th>Rating</th>
                            <th>Comment</th>
                            <th class="text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="review : ${reviews}" th:classappend="${review.hidden} ? 'table-secondary text-muted' : ''">
                            <td th:text="${review.reviewerName}"></td>
                            <td>
                                <span th:if="${review.driver}" class="badge bg-primary">Driver</span>
                                <span th:if="${review.route}" class="badge bg-success">Route</span>
                                <span th:if="${review.vehicle}" class="badge bg-warning text-dark">Vehicle</span>
                            </td>
                            <td><span th:text="${review.rating}"></span> <i class="fas fa-star text-warning small"></i></td>
                            <td th:text="${review.comment}"></td>
                            <td class="text-end">
                                <div th:if="${!review.hidden}">
                                    <form th:action="@{/admin/hide/{id}(id=${review.id})}" method="post" class="d-inline">
                                        <button class="btn btn-sm btn-outline-secondary">Hide</button>
                                    </form>
                                    <form th:action="@{/admin/delete/{id}(id=${review.id})}" method="post" class="d-inline">
                                        <button class="btn btn-sm btn-outline-danger">Delete</button>
                                    </form>
                                </div>
                                <div th:if="${review.hidden}">
                                    <form th:action="@{/admin/show/{id}(id=${review.id})}" method="post" class="d-inline">
                                        <button class="btn btn-sm btn-success">Show</button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    var starCounts = /*[[${starCounts}]]*/ [0, 0, 0, 0, 0]; 
    var ctx = document.getElementById('ratingDistChart').getContext('2d');
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
            datasets: [{
                label: 'Count',
                data: starCounts,
                backgroundColor: ['#ef5350', '#ff9800', '#ffca28', '#42a5f5', '#66bb6a']
            }]
        },
        options: { scales: { y: { beginAtZero: true } } }
    });
    /*]]>*/
</script>

</body>
</html>